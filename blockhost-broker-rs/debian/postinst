#!/bin/sh
set -e

. /usr/share/debconf/confmodule

CONFIG_DIR="/etc/blockhost-broker"
DATA_DIR="/var/lib/blockhost-broker"
OPERATOR_KEY="$CONFIG_DIR/operator.key"
ECIES_KEY="$CONFIG_DIR/ecies.key"
WG_PRIVATE_KEY="$CONFIG_DIR/wg-private.key"
WG_PUBLIC_KEY="$CONFIG_DIR/wg-public.key"
CONFIG_FILE="$CONFIG_DIR/config.toml"

RPC_URL="https://ethereum-sepolia-rpc.publicnode.com"
CHAIN_ID="11155111"

case "$1" in
    configure)
        # $2 is the previously installed version (empty on fresh install)
        PREVIOUS_VERSION="$2"

        # Create system user (shared across blockhost components)
        if ! getent passwd blockhost >/dev/null 2>&1; then
            adduser --system --group --no-create-home --shell /usr/sbin/nologin blockhost
            echo "Created system user 'blockhost'"
        fi

        # Create directories
        if [ ! -d "$CONFIG_DIR" ]; then
            mkdir -p "$CONFIG_DIR"
            chmod 750 "$CONFIG_DIR"
        fi
        chown blockhost:blockhost "$CONFIG_DIR"

        if [ ! -d "$DATA_DIR" ]; then
            mkdir -p "$DATA_DIR"
            chmod 750 "$DATA_DIR"
        fi
        chown blockhost:blockhost "$DATA_DIR"

        # --- Upgrade path: binary replaced, migrate ownership, restart ---
        if [ -n "$PREVIOUS_VERSION" ]; then
            echo "Upgrading blockhost-broker from $PREVIOUS_VERSION â€” preserving existing configuration"
            # Migrate ownership from root to blockhost user
            chown -R blockhost:blockhost "$CONFIG_DIR" "$DATA_DIR"
            if systemctl is-active --quiet blockhost-broker 2>/dev/null; then
                systemctl restart blockhost-broker
                echo "Service restarted"
            fi
            exit 0
        fi

        # --- Fresh install path below ---

        # Configure sysctl for IPv6 forwarding and NDP proxy
        SYSCTL_CONF="/etc/sysctl.d/99-blockhost-broker.conf"
        if [ ! -f "$SYSCTL_CONF" ]; then
            cat > "$SYSCTL_CONF" << 'SYSCTL_EOF'
# Blockhost Broker - IPv6 forwarding and NDP proxy settings
# Enable IPv6 forwarding (required for routing traffic between interfaces)
net.ipv6.conf.all.forwarding = 1

# Enable NDP proxy (required for upstream to reach client addresses)
net.ipv6.conf.all.proxy_ndp = 1
SYSCTL_EOF
            echo "Created sysctl configuration at $SYSCTL_CONF"
        fi

        # Apply sysctl settings
        sysctl -p "$SYSCTL_CONF" >/dev/null 2>&1 || true

        # Configure UFW rules if UFW is installed and active
        if command -v ufw >/dev/null 2>&1; then
            db_get blockhost-broker/wg-interface
            UFW_WG_IFACE="${RET:-wg-broker}"
            db_get blockhost-broker/wg-port
            UFW_WG_PORT="${RET:-51820}"
            db_get blockhost-broker/upstream-interface
            UFW_UPSTREAM="${RET}"

            ufw allow "${UFW_WG_PORT}/udp" comment "Blockhost WireGuard" >/dev/null 2>&1 || true

            if [ -n "$UFW_UPSTREAM" ]; then
                ufw route allow in on "$UFW_WG_IFACE" out on "$UFW_UPSTREAM" comment "Blockhost forward WG->upstream" >/dev/null 2>&1 || true
                ufw route allow in on "$UFW_UPSTREAM" out on "$UFW_WG_IFACE" comment "Blockhost forward upstream->WG" >/dev/null 2>&1 || true
                echo "Configured UFW forwarding rules for $UFW_WG_IFACE <-> $UFW_UPSTREAM"
            fi

            echo "Configured UFW to allow WireGuard on port $UFW_WG_PORT/udp"
        fi

        # Generate operator key if not present
        if [ ! -f "$OPERATOR_KEY" ]; then
            /usr/bin/blockhost-broker wallet generate -o "$OPERATOR_KEY" 2>/dev/null || {
                openssl rand -hex 32 > "$OPERATOR_KEY"
                chmod 600 "$OPERATOR_KEY"
            }
            chown blockhost:blockhost "$OPERATOR_KEY"
            echo "Generated new operator key at $OPERATOR_KEY"
        fi

        # Get wallet address if key exists
        WALLET_ADDRESS=""
        if [ -f "$OPERATOR_KEY" ]; then
            WALLET_ADDRESS=$(/usr/bin/blockhost-broker wallet address -k "$OPERATOR_KEY" 2>/dev/null || echo "")
        fi

        # Generate WireGuard keys if needed
        if [ ! -f "$WG_PRIVATE_KEY" ]; then
            wg genkey > "$WG_PRIVATE_KEY"
            chmod 600 "$WG_PRIVATE_KEY"
            wg pubkey < "$WG_PRIVATE_KEY" > "$WG_PUBLIC_KEY"
            chown blockhost:blockhost "$WG_PRIVATE_KEY" "$WG_PUBLIC_KEY"
            echo "Generated WireGuard keys"
            echo "Public key: $(cat $WG_PUBLIC_KEY)"
        fi

        # Generate ECIES key if needed
        if [ ! -f "$ECIES_KEY" ]; then
            /usr/bin/blockhost-broker generate-key -o "$ECIES_KEY" >/dev/null 2>&1 || {
                echo "Warning: Could not generate ECIES key. Run manually:"
                echo "  blockhost-broker generate-key -o $ECIES_KEY"
            }
            [ -f "$ECIES_KEY" ] && chown blockhost:blockhost "$ECIES_KEY"
        fi

        # Get debconf values for configuration
        db_get blockhost-broker/ipv6-prefix
        UPSTREAM_PREFIX="$RET"

        db_get blockhost-broker/allocation-size
        ALLOCATION_SIZE="${RET:-64}"

        db_get blockhost-broker/broker-ipv6
        BROKER_IPV6="$RET"

        db_get blockhost-broker/wg-interface
        WG_INTERFACE="${RET:-wg-broker}"

        db_get blockhost-broker/wg-port
        WG_PORT="${RET:-51820}"

        db_get blockhost-broker/wg-endpoint
        WG_ENDPOINT="$RET"

        db_get blockhost-broker/upstream-interface
        UPSTREAM_INTERFACE="$RET"

        # Get existing contract address if provided
        REQUESTS_CONTRACT=""
        db_get blockhost-broker/existing-contract
        REQUESTS_CONTRACT="$RET"

        # Write configuration file (fresh install only)
        if [ ! -f "$CONFIG_FILE" ]; then
            cat > "$CONFIG_FILE" << EOF
# Blockhost Broker Configuration
# Generated during package installation

[broker]
upstream_prefix = "${UPSTREAM_PREFIX:-2001:db8::/48}"
allocation_size = ${ALLOCATION_SIZE:-64}
broker_ipv6 = "${BROKER_IPV6:-2001:db8::1}"

[wireguard]
interface = "${WG_INTERFACE}"
listen_port = ${WG_PORT}
private_key_file = "$WG_PRIVATE_KEY"
public_endpoint = "${WG_ENDPOINT:-your-server.example.com:51820}"

[api]
listen_host = "127.0.0.1"
listen_port = 8080

[database]
path = "$DATA_DIR/ipam.db"

[onchain]
enabled = true
rpc_url = "$RPC_URL"
chain_id = $CHAIN_ID
private_key_file = "$OPERATOR_KEY"
ecies_private_key_file = "$ECIES_KEY"
EOF

            if [ -n "$REQUESTS_CONTRACT" ]; then
                echo "requests_contract = \"$REQUESTS_CONTRACT\"" >> "$CONFIG_FILE"
            else
                echo "# requests_contract = \"0x...\"" >> "$CONFIG_FILE"
            fi

            echo "poll_interval_ms = 5000" >> "$CONFIG_FILE"

            if [ -n "$UPSTREAM_INTERFACE" ]; then
                sed -i "/^public_endpoint = /a upstream_interface = \"$UPSTREAM_INTERFACE\"" "$CONFIG_FILE"
            fi

            chmod 640 "$CONFIG_FILE"
            chown blockhost:blockhost "$CONFIG_FILE"
            echo "Configuration written to $CONFIG_FILE"
        fi

        # Summary
        echo ""
        echo "=========================================="
        echo "  Blockhost Broker Installation Complete"
        echo "=========================================="
        echo ""
        if [ -n "$WALLET_ADDRESS" ]; then
            echo "Operator wallet: $WALLET_ADDRESS"
        fi
        if [ -f "$ECIES_KEY" ]; then
            echo "ECIES key: $ECIES_KEY"
        fi
        if [ -f "$WG_PUBLIC_KEY" ]; then
            echo "WireGuard public key: $(cat $WG_PUBLIC_KEY)"
        fi
        echo ""
        echo "Next steps:"
        echo "  1. Deploy contracts: blockhost-broker deploy-contracts"
        echo "  2. Update config:    /etc/blockhost-broker/config.toml"
        echo "  3. Start service:    systemctl enable --now blockhost-broker"
        echo ""
        ;;
esac

#DEBHELPER#

exit 0
